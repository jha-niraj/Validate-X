generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

enum Role {
    USER        // Validator - Can validate ideas
    SUBMITTER   // Can submit ideas for validation
    ADMIN       // Admin privileges
}

enum PostStatus {
    DRAFT         // Draft, not yet published
    OPEN          // Open for validation
    CLOSED        // Closed, validation complete
    EXPIRED       // Expired without completion
}

enum PostType {
    MEDIA_VALIDATION      // Group 1: Images/Videos
    DOCUMENT_VALIDATION   // Group 2: PDFs/Documents
    POLL_VALIDATION       // Group 3: Polls/Surveys
    LINK_VALIDATION       // Group 4: URLs/Links
    CUSTOM_VALIDATION     // Group 5: Custom/Mixed
}

enum MediaValidationSubtype {
    THUMBNAIL_SELECTION   // Image selection/ranking
    DESIGN_FEEDBACK      // UI/Design mockups
    VIDEO_REVIEW         // Video snippet review
}

enum DocumentValidationSubtype {
    PROJECT_REVIEW       // PDF/Document review
    CONTENT_FEEDBACK     // Text/Script feedback
    POLICY_VALIDATION    // Policy/Report validation
}

enum PollValidationSubtype {
    BINARY_POLL          // Yes/No poll
    MULTIPLE_CHOICE      // Multiple choice survey
    RANKING_POLL         // Ranking poll
}

enum LinkValidationSubtype {
    WEBSITE_USABILITY    // Website usability
    APP_PROTOTYPE        // App prototype test
    SOCIAL_MEDIA_POST    // Social media validation
}

enum CustomValidationSubtype {
    GENERIC_UPLOAD       // Generic file upload
    HYBRID_FORMAT        // Multiple formats
    OPEN_QUERY          // Open-ended question
}

enum ValidationType {
    NORMAL        // Quick vote (Yes/No/Neutral)
    DETAILED      // Detailed feedback with rating
}

enum ValidationStatus {
    PENDING       // Submitted, awaiting approval (detailed only)
    APPROVED      // Approved by submitter
    REJECTED      // Rejected by submitter
    COMPLETED     // Normal validation (auto-approved)
}

enum PaymentMethod {
    UPI           // UPI payment method
    BLOCKCHAIN    // Blockchain wallet payment
    RAZORPAY      // UPI/Cards via Razorpay (deprecated)
    PHONEPE       // UPI via PhonePe (deprecated)
    POLYGON       // Crypto via Polygon blockchain (deprecated)
}

enum TransactionType {
    VALIDATION_EARNING // Earning from validation
    POST_PAYMENT      // Payment for post creation
    CASHOUT          // Cash-out withdrawal
    BONUS            // Bonus rewards
    REFUND           // Refund for rejected post
}

model User {
    id                   String    @id @default(cuid())
    email                String    @unique
    emailVerified        DateTime?
    password             String?
    name                 String
    image                String?
    bio                  String?
    location             String?
    website              String?
    skills               String?   // JSON string of skills array
    interests            String?   // JSON string of interests array
    role                 Role      @default(USER)
    
    // Onboarding fields
    selectedCategories   CategorySelection[]
    onboardingCompleted  Boolean   @default(false)
    
    roleExplicitlyChosen Boolean   @default(false)
    createdAt            DateTime  @default(now())
    updatedAt            DateTime  @updatedAt

    // Stats for gamification
    totalValidations     Int       @default(0)
    totalIdeasSubmitted  Int       @default(0)
    reputationScore      Int       @default(0)
    
    // Wallet fields
    totalBalance         Decimal   @default(0) @db.Decimal(10,2)
    availableBalance     Decimal   @default(0) @db.Decimal(10,2)
    optedOutBalance      Decimal   @default(0) @db.Decimal(10,2)
    upiId                String?
    paytmNumber          String?
    walletAddress        String?   // For Polygon blockchain rewards
    
    // Payment preferences
    preferredPaymentMethod PaymentMethod?
    lastCashoutAt        DateTime?

    // Email verification
    verificationToken    String?   @unique
    verificationTokenExpiry DateTime?

    // Password reset
    resetToken           String?   @unique
    resetTokenExpiry     DateTime?

    accounts             Account[]
    posts                Post[]
    validations          Validation[]
    transactions         Transaction[]
    cashoutRequests      CashoutRequest[]

    @@index([email])
}

model Category {
    id          String    @id @default(cuid())
    name        String    @unique
    description String?
    icon        String?   // Icon name or emoji
    isActive    Boolean   @default(true)
    createdAt   DateTime  @default(now())
    updatedAt   DateTime  @updatedAt
    
    selections  CategorySelection[]
    posts       Post[]

    @@index([name])
}

model CategorySelection {
    id         String   @id @default(cuid())
    userId     String
    categoryId String
    createdAt  DateTime @default(now())
    
    user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
    category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)
    
    @@unique([userId, categoryId])
    @@index([userId])
    @@index([categoryId])
}

model Post {
    id                    String     @id @default(cuid())
    title                 String
    description           String
    categoryId            String
    authorId              String
    
    // Post type and subtype
    postType              PostType
    postSubtype           String?    // Stores the specific subtype enum value as string
    
    // Content based on type
    mediaUrls             String[]   @default([])  // For images/videos (array for multiple files)
    documentUrl           String?                  // For PDFs/documents
    linkUrl               String?                  // For website/app links
    
    // Poll-specific data (stored as JSON)
    pollOptions           String?    // JSON array of poll options
    pollSettings          String?    // JSON object with poll configuration
    
    // Custom validation instructions
    customInstructions    String?    // For custom validation types
    
    // Files and attachments
    fileUrl               String?    // Legacy - keeping for backward compatibility
    fileName              String?
    fileType              String?
    
    // Validation requirements
    normalValidatorCount  Int        @default(500)
    detailedValidatorCount Int       @default(100)
    currentNormalCount    Int        @default(0)
    currentDetailedCount  Int        @default(0)
    
    // Budget and payments
    totalBudget           Decimal    @db.Decimal(10,2)
    normalReward          Decimal    @db.Decimal(10,2)
    detailedReward        Decimal    @db.Decimal(10,2)
    platformFee           Decimal    @db.Decimal(10,2)
    
    // Settings
    allowAIFeedback       Boolean    @default(true)
    detailedApprovalRequired Boolean @default(true)
    enableDetailedFeedback Boolean   @default(false)
    detailedFeedbackStructure String? // JSON string of feedback questions/categories
    
    // Status and timing
    status                PostStatus @default(DRAFT)
    expiryDate            DateTime
    
    createdAt             DateTime   @default(now())
    updatedAt             DateTime   @updatedAt
    
    author                User       @relation(fields: [authorId], references: [id], onDelete: Cascade)
    category              Category   @relation(fields: [categoryId], references: [id])
    validations           Validation[]
    
    @@index([authorId])
    @@index([categoryId])
    @@index([status])
    @@index([expiryDate])
}

model Validation {
    id                String           @id @default(cuid())
    postId            String
    validatorId       String
    type              ValidationType
    
    // Basic validation data
    vote              String?          // LIKE, DISLIKE, NEUTRAL for normal
    shortComment      String?
    
    // Type-specific validation responses (stored as JSON)
    mediaResponse     String?          // Rankings, selections for media
    pollResponse      String?          // Poll answers, rankings
    documentResponse  String?          // Document feedback, annotations
    linkResponse      String?          // Website usability feedback
    customResponse    String?          // Custom validation responses
    
    // Detailed validation data
    detailedFeedback  String?
    detailedResponses String?          // JSON string of structured responses
    rating            Int?             // 1-5 scale
    feedbackFileUrl   String?
    feedbackFileName  String?
    
    // Quality and approval
    isOriginal        Boolean          @default(false) // Human-certified checkbox
    originalityScore  Decimal?         @db.Decimal(3,2) // Plagiarism score
    status            ValidationStatus @default(PENDING)
    approvalReason    String?          // Reason for approval/rejection
    
    // Rewards
    rewardAmount      Decimal          @db.Decimal(10,2)
    isPaid            Boolean          @default(false)
    
    createdAt         DateTime         @default(now())
    updatedAt         DateTime         @updatedAt
    
    post              Post             @relation(fields: [postId], references: [id], onDelete: Cascade)
    validator         User             @relation(fields: [validatorId], references: [id], onDelete: Cascade)
    
    @@unique([postId, validatorId]) // One validation per user per post
    @@index([postId])
    @@index([validatorId])
    @@index([status])
}

enum CashoutStatus {
    PENDING       // Submitted, awaiting admin review
    APPROVED      // Approved by admin, payment in progress  
    COMPLETED     // Payment completed
    REJECTED      // Rejected by admin
    CANCELLED     // Cancelled by user
}

model CashoutRequest {
    id              String          @id @default(cuid())
    userId          String
    amount          Decimal         @db.Decimal(10,2)
    method          PaymentMethod
    
    // Payment details based on method
    upiId           String?
    paytmNumber     String?
    walletAddress   String?
    
    // Admin review
    status          CashoutStatus   @default(PENDING)
    adminNotes      String?
    reviewedBy      String?         // Admin user ID
    reviewedAt      DateTime?
    
    // Payment processing
    transactionId   String?         // External payment gateway transaction ID
    processedAt     DateTime?
    
    createdAt       DateTime        @default(now())
    updatedAt       DateTime        @updatedAt
    
    user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    @@index([userId])
    @@index([status])
    @@index([createdAt])
}

model Transaction {
    id              String          @id @default(cuid())
    userId          String
    amount          Decimal         @db.Decimal(10,2)
    type            TransactionType
    method          PaymentMethod?
    
    // Related entities
    postId          String?         // For post payments
    validationId    String?         // For validation earnings
    
    // Transaction details
    description     String
    status          String          @default("COMPLETED") // PENDING, COMPLETED, FAILED
    transactionId   String?         // External payment gateway ID
    
    createdAt       DateTime        @default(now())
    updatedAt       DateTime        @updatedAt
    
    user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
    
    @@index([userId])
    @@index([type])
    @@index([createdAt])
}

model Account {
    id                String  @id @default(uuid())
    userId            String
    type              String
    provider          String
    providerAccountId String
    refresh_token     String?
    access_token      String?
    expires_at        Int?
    token_type        String?
    scope             String?
    id_token          String?
    session_state     String?

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    @@unique([provider, providerAccountId])
    @@map("accounts")
}

model WaitingList {
    id        String   @id @default(cuid())
    email     String   @unique
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@index([email])
    @@map("waiting_list")
}